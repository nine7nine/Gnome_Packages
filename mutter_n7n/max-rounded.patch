From 76910f7a4631f4760c504e21e045da6699b52d20 Mon Sep 17 00:00:00 2001
From: LuoYi <langisme@qq.com>
Date: Sun, 24 Apr 2022 13:20:58 +0800
Subject: [PATCH] Add config item: rounded-in-maximized

---
 data/org.gnome.mutter.gschema.xml.in |  10 +-
 src/compositor/compositor.c          |   4 +
 src/compositor/meta-window-actor.c   |   8 +-
 src/core/prefs.c                     |  17 +++
 src/meta/prefs.h                     |   4 +
 src/ui/frames.h.orig                 | 153 ---------------------------
 6 files changed, 38 insertions(+), 158 deletions(-)
 delete mode 100644 src/ui/frames.h.orig

diff --git a/data/org.gnome.mutter.gschema.xml.in b/data/org.gnome.mutter.gschema.xml.in
index f5f77c05da..692bd5c806 100644
--- a/data/org.gnome.mutter.gschema.xml.in
+++ b/data/org.gnome.mutter.gschema.xml.in
@@ -30,7 +30,7 @@
     <key name="blur-window-opacity" type="i">
       <default>80</default>
       <range min="0" max="100"/>
-      <summary>Blur brightness</summary>
+      <summary>Blur Window opacity</summary>
     </key>
 
     <key name="border-width" type="i">
@@ -88,6 +88,14 @@
       </description>
     </key>
 
+    <key name="rounded-in-maximized" type="b">
+      <default>false</default>
+      <summary>Enable rounded corners when windows maximized</summary>
+      <description>
+        When true, the windows will always be clipped when be maximized.
+      </description>
+    </key>
+
     <key name="overlay-key" type="s">
       <default>'Super_L'</default>
       <summary>Modifier to use for extended window management operations</summary>
diff --git a/src/compositor/compositor.c b/src/compositor/compositor.c
index dec3d63d51..ecc0725106 100644
--- a/src/compositor/compositor.c
+++ b/src/compositor/compositor.c
@@ -1149,6 +1149,10 @@ prefs_changed_cb(MetaPreference pref,
     case META_PREF_BLUR_WINDOW_OPACITY:
       meta_window_actor_update_blur_window_opacity (l->data);
       break;
+    case META_PREF_ROUNDED_IN_MAXIMIZED:
+      meta_window_actor_update_glsl (l->data);
+      meta_window_actor_update_blur_position_size(l->data);
+      break;
     default:
       break;
     }
diff --git a/src/compositor/meta-window-actor.c b/src/compositor/meta-window-actor.c
index de5775768c..a721737a2f 100644
--- a/src/compositor/meta-window-actor.c
+++ b/src/compositor/meta-window-actor.c
@@ -159,7 +159,7 @@ meta_window_actor_update_blur_position_size(MetaWindowActor *self)
   meta_window_get_frame_rect (priv->window, &frame_rect);
   meta_window_get_buffer_rect (priv->window, &buf_rect);
 
-  if (meta_window_get_maximized (priv->window) ||
+  if ((meta_window_get_maximized (priv->window) && !meta_prefs_get_rounded_in_maximized()) ||
       meta_window_is_fullscreen (priv->window))
     {
       clutter_actor_set_position (priv->blur_actor,
@@ -324,9 +324,9 @@ meta_window_actor_should_clip(MetaWindowActor *self)
 {
   MetaWindowActorPrivate *priv = meta_window_actor_get_instance_private (self);
 
-  return priv->should_clip && 
-        !(meta_window_get_maximized(priv->window)||
-          meta_window_is_fullscreen(priv->window)); 
+  return priv->should_clip  && 
+        !((meta_window_get_maximized(priv->window) && !meta_prefs_get_rounded_in_maximized())
+          || meta_window_is_fullscreen(priv->window)); 
 }
 
 void
diff --git a/src/core/prefs.c b/src/core/prefs.c
index 29bddc170b..1889b27a7f 100644
--- a/src/core/prefs.c
+++ b/src/core/prefs.c
@@ -128,6 +128,7 @@ static int border_brightness = 40;
 static int blur_sigmal = 20;
 static int blur_window_opacity = 80;
 static int blur_brightness = 100;
+static gboolean rounded_in_maximized = FALSE;
 static JsonNode *clip_edge_padding = NULL;
 /* NULL-terminated array */
 static char **black_list = NULL;
@@ -415,6 +416,13 @@ static MetaBoolPreference preferences_bool[] =
       },
       &locate_pointer_is_enabled,
     },
+    {
+      { "rounded-in-maximized",
+        SCHEMA_MUTTER,
+        META_PREF_ROUNDED_IN_MAXIMIZED,
+      },
+      &rounded_in_maximized,
+    },
     { { NULL, 0, 0 }, NULL },
   };
 
@@ -1948,6 +1956,9 @@ meta_preference_to_string (MetaPreference pref)
 
     case META_PREF_BLUR_WINDOW_OPACITY:
       return "BLUR_WINDOW_OPACITY";
+
+    case META_PREF_ROUNDED_IN_MAXIMIZED:
+      return "ROUNDED_IN_MAXIMIZED";    
     }
 
   return "(unknown)";
@@ -2495,6 +2506,12 @@ meta_prefs_get_blur_window_opacity(void)
   return blur_window_opacity * 255 * 0.01;
 }
 
+gboolean
+meta_prefs_get_rounded_in_maximized(void)
+{
+  return rounded_in_maximized;
+}
+
 gboolean
 meta_prefs_in_blur_list(const char *name)
 {
diff --git a/src/meta/prefs.h b/src/meta/prefs.h
index 7d5d8f3471..f005f47e80 100644
--- a/src/meta/prefs.h
+++ b/src/meta/prefs.h
@@ -116,6 +116,7 @@ typedef enum
   META_PREF_BLUR_BRIGHTNESS,
   META_PREF_BLUR_LIST,
   META_PREF_BLUR_WINDOW_OPACITY,
+  META_PREF_ROUNDED_IN_MAXIMIZED,
 } MetaPreference;
 
 typedef void (* MetaPrefsChangedFunc) (MetaPreference pref,
@@ -267,6 +268,9 @@ double   meta_prefs_get_blur_brightness(void);
 META_EXPORT
 int      meta_prefs_get_blur_window_opacity(void);
 
+META_EXPORT
+gboolean meta_prefs_get_rounded_in_maximized(void);
+
 META_EXPORT
 gboolean meta_prefs_in_blur_list(const char *name);
 
